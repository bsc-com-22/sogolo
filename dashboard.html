<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Sogolo</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <a href="index.html" class="logo">
                <img src="logo.png" alt="Sogolo" style="width: 32px; height: 32px;">
                Sogolo
            </a>
            <div class="flex gap-4 items-center">
                <a href="admin-dashboard.html" id="adminBtn" class="btn btn-primary hidden">Admin Dashboard</a>
                <button id="logoutBtn" class="btn btn-secondary">Logout</button>
            </div>
        </div>
    </header>

    <div class="container" style="margin-top: 100px; padding-bottom: 4rem;">
        <!-- User Welcome & KYC Status -->
        <div class="card mb-4 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div id="userAvatar" style="width: 48px; height: 48px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; font-weight: 600;">U</div>
                <div>
                    <h2 id="userEmail" style="font-size: 1.25rem; font-weight: 600;">Loading...</h2>
                    <p style="color: var(--text-muted);">Welcome back!</p>
                </div>
            </div>
            <div id="kycStatusBadge">
                <!-- Injected via JS -->
            </div>
        </div>

        <!-- Transactions -->
        <div class="card">
            <div class="flex justify-between items-center mb-4">
                <h3 style="font-size: 1.25rem; font-weight: 600;">My Transactions</h3>
                <a href="create-transaction.html" class="btn btn-primary">Create New Transaction</a>
            </div>

            <div id="transactionList">
                <p style="color: var(--text-muted);">Loading transactions...</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { logout, getCurrentUser, initAuthStateListener } from './js/auth.js';
        import { supabase } from './js/supabaseClient.js';

        initAuthStateListener();

        async function loadDashboard() {
            const user = await getCurrentUser();
            if (!user) return; // Auth listener will redirect

            // 1. User Info
            document.getElementById('userEmail').textContent = user.email;
            if (user.email) {
                document.getElementById('userAvatar').textContent = user.email.charAt(0).toUpperCase();
            }

            // 2. Admin Button
            if (user.profile?.role === 'admin') {
                document.getElementById('adminBtn').classList.remove('hidden');
            }

            // 3. KYC Status
            const kycStatus = user.profile?.kyc_status || 'pending';
            const kycBadge = document.getElementById('kycStatusBadge');
            
            if (kycStatus === 'approved') {
                kycBadge.innerHTML = `<span class="badge badge-green">KYC Verified</span>`;
            } else if (kycStatus === 'under_review') {
                kycBadge.innerHTML = `<span class="badge badge-yellow">KYC Under Review</span>`;
            } else if (kycStatus === 'rejected') {
                kycBadge.innerHTML = `<span class="badge badge-red">KYC Rejected</span> <a href="kyc.html" style="font-size: 0.875rem; margin-left: 0.5rem;">Retry</a>`;
            } else {
                kycBadge.innerHTML = `<a href="kyc.html" class="btn btn-secondary" style="font-size: 0.875rem;">Complete Verification</a>`;
            }

            // 4. Load Transactions
            loadTransactions(user.id);
        }

        async function loadTransactions(userId) {
            const { data: transactions, error } = await supabase
                .from('transactions')
                .select('*')
                .or(`buyer_id.eq.${userId},seller_id.eq.${userId}`)
                .order('created_at', { ascending: false });

            const listContainer = document.getElementById('transactionList');
            
            if (error) {
                listContainer.innerHTML = `<div class="alert alert-error">Error loading transactions: ${error.message}</div>`;
                return;
            }

            if (!transactions || transactions.length === 0) {
                listContainer.innerHTML = `
                    <div style="text-align: center; padding: 3rem 0;">
                        <p style="color: var(--text-muted); margin-bottom: 1rem;">No transactions yet.</p>
                        <a href="create-transaction.html" class="btn btn-secondary">Start your first transaction</a>
                    </div>
                `;
                return;
            }

            listContainer.innerHTML = transactions.map(t => {
                const isBuyer = t.buyer_id === userId;
                const role = isBuyer ? 'Buyer' : 'Seller';
                
                let statusClass = 'badge-gray';
                if (t.status === 'funds_released') statusClass = 'badge-green';
                if (t.status === 'payment_verified') statusClass = 'badge-blue';
                if (t.status === 'rejected') statusClass = 'badge-red';

                return `
                    <div class="flex justify-between items-center" style="padding: 1rem; border-bottom: 1px solid var(--border);">
                        <div>
                            <h4 style="font-weight: 600; margin-bottom: 0.25rem;">${t.title}</h4>
                            <div class="flex items-center gap-2">
                                <span class="badge badge-blue">${role}</span>
                                <span style="font-size: 0.875rem; color: var(--text-muted);">${new Date(t.created_at).toLocaleDateString()}</span>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <span class="badge ${statusClass}" style="margin-bottom: 0.5rem;">${t.status.replace('_', ' ').toUpperCase()}</span>
                            <br>
                            <a href="transaction-status.html?id=${t.id}" style="font-size: 0.875rem; font-weight: 500;">View Details &rarr;</a>
                        </div>
                    </div>
                `;
            }).join('');
        }

        loadDashboard();

        document.getElementById('logoutBtn').addEventListener('click', () => logout());
    </script>
</body>
</html>
