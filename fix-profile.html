<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fix Profile</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="container" style="padding-top: 50px;">
    <div class="card">
        <h1>Fix Missing Profile</h1>
        <p>Your user account exists in Auth but is missing from the Profiles table.</p>
        <div id="status">Checking...</div>
        <button id="fixBtn" class="btn btn-primary hidden" onclick="fixProfile()">Create Admin Profile</button>
    </div>

    <script type="module">
        import { supabase } from './js/supabaseClient.js';

        const status = document.getElementById('status');
        const btn = document.getElementById('fixBtn');

        async function check() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                status.textContent = 'Not logged in. Please sign in first.';
                return;
            }

            const { data: profile } = await supabase.from('profiles').select('*').eq('id', user.id).maybeSingle();
            
            if (profile) {
                status.textContent = `Profile found! Role: ${profile.role}. You are good to go.`;
                if (profile.role !== 'admin') {
                    status.textContent += ' (Not an admin though)';
                    btn.textContent = 'Make Me Admin';
                    btn.classList.remove('hidden');
                    btn.onclick = makeAdmin;
                }
            } else {
                status.textContent = 'No profile found. Click below to fix.';
                btn.classList.remove('hidden');
            }
        }

        window.fixProfile = async () => {
            const { data: { user } } = await supabase.auth.getUser();
            const { error } = await supabase.from('profiles').insert([{
                id: user.id,
                full_name: user.user_metadata.full_name || 'Admin User',
                role: 'admin',
                kyc_status: 'approved'
            }]);

            if (error) {
                alert('Error: ' + error.message);
            } else {
                alert('Profile created! You are now an admin.');
                window.location.href = 'admin-dashboard.html';
            }
        };

        window.makeAdmin = async () => {
            const { data: { user } } = await supabase.auth.getUser();
            const { error } = await supabase.from('profiles')
                .update({ role: 'admin', kyc_status: 'approved' })
                .eq('id', user.id);

            if (error) {
                alert('Error: ' + error.message);
            } else {
                alert('Updated! You are now an admin.');
                window.location.href = 'admin-dashboard.html';
            }
        };

        check();
    </script>
</body>
</html>
